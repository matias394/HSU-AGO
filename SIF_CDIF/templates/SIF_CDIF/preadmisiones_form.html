{% extends "includes/base.html" %};
{% load crispy_forms_tags %}
{% load static %};

{% block head %}{% endblock %}

{% block title %}Pre-admisiones formulario{% endblock %};

{% block titulo-pagina %} Pre-admisiones {% endblock %};

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="{% url 'CDIF_derivaciones_listar'%}"
            title="Ver listado de Pre-admisiones">Pre-admisiones</a></li>
    <li class="breadcrumb-item "><a href="{% url 'legajos_ver' legajo.fk_legajo.id %}"
            title="Ver legajo">{{legajo.fk_legajo}}</a></li>
            {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
            <li class="breadcrumb-item active">Editar</li>
            {% else %}
            <li class="breadcrumb-item active">Agregar</li>
            {% endif %}
</ol>
{% endblock %};

{% block menu-adicional %}
{% endblock %};

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card card-primary card-outline">
            <div class="bs-stepper">
                <div class="bs-stepper-header" role="tablist">

                    <div class="step" data-target="#grupo-familiar">
                        <button type="button" class="step-trigger" role="tab" aria-controls="grupo-familiar"
                            id="grupo-familiar-trigger">
                            <span class="bs-stepper-circle">1</span>
                            <span class="bs-stepper-label">Grupo Familiar</span>
                        </button>
                    </div>
                    <div class="line"></div>
                    <div class="step" data-target="#cuidador-Guarda">
                        <button type="button" class="step-trigger" role="tab" aria-controls="cuidador-Guarda"
                            id="cuidador-Guarda-trigger">
                            <span class="bs-stepper-circle">2</span>
                            <span class="bs-stepper-label">Guarda o cuidador principal</span>
                        </button>
                    </div>
                    <div class="line"></div>
                    <div class="step" data-target="#cuidador-principal">
                        <button type="button" class="step-trigger" role="tab" aria-controls="cuidador-principal"
                            id="cuidador-principal-trigger">
                            <span class="bs-stepper-circle">3</span>
                            <span class="bs-stepper-label">Madre o cuidador principal</span>
                        </button>
                    </div>
                    <div class="line"></div>
                    <div class="step" data-target="#cuidador-secundario">
                        <button type="button" class="step-trigger" role="tab" aria-controls="cuidador-secundario"
                            id="cuidador-secundario-trigger">
                            <span class="bs-stepper-circle">4</span>
                            <span class="bs-stepper-label">Padre o apoyo en la crianza</span>
                        </button>
                    </div>
                    <div class="line"></div>
                    <div class="step" data-target="#info-centro">
                        <button type="button" class="step-trigger" role="tab" aria-controls="info-centro"
                            id="info-centro-trigger">
                            <span class="bs-stepper-circle">5</span>
                            <span class="bs-stepper-label">Información de la postulación</span>
                        </button>
                    </div>
                    
                </div>
                <div class="card-body py-0 px-2 mt-5">
                    <form novalidate method="POST" enctype="multipart/form-data" class="needs-validation">
                        <!-- Security token -->
                        {% csrf_token %}
                        <input type="hidden" id="id_fk_derivacion" name="fk_derivacion" value={{pk}}>
                        <input type="hidden" id="id_fk_legajo" name="fk_legajo" value={{legajo.fk_legajo.id}}>
                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                        <input type="hidden" id="id_modificado_por" name="modificado_por" value={{ user.id }}>
                        {% else %}
                        <input type="hidden" id="id_creado_por" name="creado_por" value={{ user.id }}>
                        {% endif %}
                    <div class="bs-stepper-content">
                        <div id="grupo-familiar" class="content" role="tabpanel" aria-labelledby="grupo-familiar-trigger">
                            <div class="form-row-12">
                                <div class="row mt-5">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title font-weight-bold">
                                                    Grupo familiar
                                                </h3>
                                            </div>
                                            <div class="card-body bg-light">
                                                <div id="tablaResultado"
                                                    class="row text-center d-flex justify-content-center justify-content-sm-start px-2">
                                                    {% if familia or familia_inversa %}
                                                        {% for f in familia %}
                                                        <div id="familiar-{{f.id}}" class="px-2">
                                                            <ul class="users-list">
                                                                <li style="width:auto">
                                                                    {% if f.foto %}
                                                                    
                                                                    <img src="{{MEDIA_URL}}{{f.familia_inversa.foto.url}}" alt="User Image"
                                                                        width="60px">
                                                                    {%else%}
                                                                    <img src="{% static 'custom/img/default.png'  %}" alt="User Image" width="60px">
                                                                    {%endif%}
                                                                    <span class="users-list-name">{{f.fk_legajo_1}}</span>
                                                                    <span class="users-list-date">{{f.vinculo_inverso}}</span>
                                                                    <span class="users-list-date"><button class="btn btn-danger btn-sm"
                                                                            onclick='deleteFamiliar("{{f.id}}")'
                                                                            type="submit">Eliminar</button></span>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                        {% empty %}
                                                        {% endfor %}
                                                    {% for f in familia_inversa %}
                                                    <div id="familiar-{{f.id}}" class="px-2">
                                                        <ul class="users-list">
                                                            <li style="width:auto">
                                                                {% if f.foto %}
                                                                <img src="{{MEDIA_URL}}{{f.fk_legajo_1.foto.url}}" alt="User Image"
                                                                    width="60px">
                                                                {%else%}
                                                                <img src="{% static 'custom/img/default.png'  %}" alt="User Image" width="60px">
                                                                {%endif%}
                                                                <span class="users-list-name">{{f.fk_legajo_2}}</span>
                                                                <span class="users-list-date">{{f.vinculo_inverso}}</span>
                                                                <span class="users-list-date"><button class="btn btn-danger btn-sm"
                                                                        onclick='deleteFamiliar("{{f.id}}")'
                                                                        type="submit">Eliminar</button></span>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    {% empty %}
                                                    {% endfor %}
                                                    {%else%}
                                                    <div class="col-12 text-center" id="sin-familiares">
                                                        <h6 class="text-muted">Sin grupo familiar</h6>
                                                    </div>
                                                    {%endif%}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12 mt-3">
                                        <div class="card">
                                            <div class="card-header">
            
                                                <div class="row align-items-between">
                                                    <div class="col mb-3 mb-sm-none ">
                                                        <h3 class="card-title font-weight-bold pt-1 mr-3"> Agregar familiar</h3>
                                                    </div>
                                                    <div class="col-sm-8">
                                                        <form id="search-form" autocomplete="off">
                                                            {% csrf_token %}
                                                            <div class="form-row justify-content-sm-end">
                                                                <div class="form-group col-sm-3 mb-0 mb-0 pb-0">
                                                                    <input type="text" class="form-control " id="search-input"
                                                                        placeholder="Buscar">
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive text-nowrap">
                                                    <table id="tabla" class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>Apellido</th>
                                                                <th>Nombre</th>
                                                                <th>Documento</th>
                                                                <th>Vínculo</th>
                                                                <th>Estado Relación</th>
                                                                <th class="text-center">Convive</th>
                                                                <th class="text-center">Cuidador Principal</th>
                                                                <th class="text-center">Nivel educativo</th>
                                                                <th class="text-center">Estado nivel educativo</th>
                                                                <th class="text-right"></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="results-box">
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="row d-none" id="nuevo_legajo_familiar">
                                                    <form autocomplete="off" method="POST" novalidate id="formulario-nuevo">
                                                        {% csrf_token %}
                                                        <div class="form-row px-3 px-sm-5 mt-3">
                                                            <div class="form-group col-12">
                                                                <div class="text-center text-muted h4 pt-3">La búsqueda no arrojó
                                                                    resultados.</div>
                                                                <div class="text-center text-muted h4 pb-3">Realice una nueva
                                                                    búsqueda o bien utilice el siguiente formulario para agregar un
                                                                    familiar nuevo.</div>
                                                            </div>
                                                            <input type="hidden" name="pk" value="{{ pk }}">
                                                            <div class="form-group col-sm-6">
                                                                {{ nuevo_grupo_familiar_form.nombre|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-6">
                                                                {{ nuevo_grupo_familiar_form.apellido|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.sexo|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.fecha_nacimiento|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.tipo_doc|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.documento|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.vinculo|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.conviven|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.max_nivel|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-sm-3">
                                                                {{ nuevo_grupo_familiar_form.estado_nivel|as_crispy_field }}
                                                            </div>
                                                            <div class="form-group col-12 text-right">
                                                                <button type="submit" name="form_nuevo" id="form_nuevo"
                                                                    class="btn btn-primary mb-3">Agregar</button>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <a class="btn btn-secondary float-left mb-3 mt-5 " onclick="stepper.previous()">Volver</a>
                            <a class="btn btn-primary float-right mb-3 mt-5 " onclick="stepper.next()">Continuar</a>
                        </div>
                        <!-- INICIO  GUARDA-->
                        <div id="cuidador-Guarda" class="content" role="tabpanel"
                        aria-labelledby="cuidador-Guarda-trigger">
                        <div class="col-12 mt-3">
                            <div class="card ">
                                <div class="card-header">
                                    <div class="card-title font-weight-bold">
                                        Datos de la Guarda o cuidador principal
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-sm-12 ">
                                            <div class="row my-3 pl-2">
                                                1. DATOS PERSONALES
                                            </div>
                                            <div class="col-sm-3 form-group">
                                                {{form.medida_abrigo_primera_vez|as_crispy_field}}
                                            </div>
                                            <div class="col-sm-3 form-group">
                                                {{form.medida_abrigo_renovado|as_crispy_field}}
                                            </div>
                                            <div class="col-sm-6 form-group">
                                                    {{form.observaciones_guarda|as_crispy_field}}
                                            </div>
                                            <div class="col-sm-6 form-group">
                                                    {{form.dni_con_domicilio_san_miguel|as_crispy_field}}
                                            </div>
                                            <div class="row pl-3">
                                                <div class="col-sm-3 form-group">
                                                    <label>Guarda o cuidador principal</label>
                                                    <select name="fk_legajo_guarda" class="form-control custom-select" id="id_fk_legajo_GUARDA">
                                                        <option value=""></option>
                                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                        <option value="{{object.fk_legajo_guarda.id}}" selected>{{object.fk_legajo_guarda}}</option>
                                                        {% endif %}
                                                        {% for f in familia %}
                                                        <option value="{{f.fk_legajo_1.id}}">{{f.fk_legajo_1}}</option>
                                                        {% endfor %}
                                                        {% for f in familia_inversa %}
                                                        <option value="{{f.fk_legajo_2.id}}">{{f.fk_legajo_2}}</option>
                                                        {% endfor %}
                                                      </select>
                                                </div>
                                                {% for f in familia %}
                                                    {%if f.fk_legajo_1 == object.fk_legajo_guarda %}
                                                        <div class="col-sm-3 form-group">
                                                            <label>Vínculo</label>
                                                            <input type="text" class="form-control" id="vinculoGUARDA" name="vinculoGUARDA" 
                                                            {% if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                            value="{{f.vinculo_inverso}}"
                                                            {% endif %}
                                                            readonly>
                                                        </div>
                                                    {%endif%}
                                                {% endfor %}
                                                {% if request.resolver_match.url_name == "CDIF_preadmisiones_crear" %}
                                                <div class="col-sm-3 form-group">
                                                    <label>Vínculo</label>
                                                    <input type="text" class="form-control" id="vinculoGUARDA" name="vinculoGUARDA" 
                                                    readonly>
                                                </div>
                                                {% endif %}
                                                <div class="col-sm-3 form-group">
                                                    <label>Tipo de documento</label>
                                                    <input type="text" class="form-control" id="tipo_docGUARDA"
                                                    {% if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.tipo_doc}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Numero documento</label>
                                                    <input type="text" class="form-control" id="documentoGUARDA" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.documento}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Fecha Nacimiento</label>
                                                    <input type="text" class="form-control" id="fecha_nacimientoGUARDA" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.fecha_nacimiento}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Estado civil</label>
                                                    <input type="text" class="form-control" id="estado_civilG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.estado_civil}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Nacionalidad</label>
                                                    <input type="text" class="form-control" id="nacionalidadG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.nacionalidad}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Telefono</label>
                                                    <input type="text" class="form-control" id="telefonoG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.telefono}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Calle</label>
                                                    <input type="text" class="form-control" id="calleG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.calle}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Altura</label>
                                                    <input type="text" class="form-control" id="alturaG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.altura}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Piso</label>
                                                    <input type="text" class="form-control" id="pisoG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.piso}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Circuito</label>
                                                    <input type="text" class="form-control" id="circuitoG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.circuito}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Barrio</label>
                                                    <input type="text" class="form-control" id="barrioG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.barrio}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    <label>Localidad</label>
                                                    <input type="text" class="form-control" id="localidadG" 
                                                    {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                    value="{{object.fk_legajo_guarda.localidad}}"
                                                    {% endif %}
                                                    readonly>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="row my-3 pl-2">
                                                2. SALUD
                                            </div>
                                            <div class="row pl-3">
                                                <div class="col-sm-3 form-group">
                                                    {{form.padece_enfermedad_psiquica|as_crispy_field}}
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    {{form.cual_enfermedad|as_crispy_field}}
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    {{form.en_tratamiento|as_crispy_field}}
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    {{form.donde_tratamiento|as_crispy_field}}
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    {{form.capacidades_reducidas|as_crispy_field}}
                                                </div>         
                                                <div class="col-sm-3 form-group">
                                                    {{form.cual_capacidades|as_crispy_field}}
                                                </div>         
                                            </div>
                                            
                                        </div>
                                        <div class="col-sm-12"> 
                                            <div class="row pl-3">                                               
                                                <div class="col-sm-3 form-group">
                                                    {{form.emb_actualmente_guarda| as_crispy_field}}
                                                </div>
                                                <div class="col-sm-3 form-group">
                                                    {{form.controles_guarda| as_crispy_field}}
                                                </div>
                                                <div class="col-sm-4 form-group">
                                                    {{form.emb_actual_guarda| as_crispy_field}}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12">
                                            <div class="row my-3 pl-2">
                                                4. EDUCACIÓN
                                            </div>
                                            <div class="row-pl-6">
                                                <div class="col-sm-3">
                                                    <div class="form-group">
                                                        {{form.leer_guarda| as_crispy_field}}
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="form-group">
                                                        {{form.escribir_guarda| as_crispy_field}}
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="form-group">
                                                        {{form.retomar_estudios_guarda| as_crispy_field}}
                                                    </div>
                                                </div>
                                                <div class="col-sm-3">
                                                    <div class="form-group">
                                                        {{form.aprender_oficio_guarda| as_crispy_field}}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12 mt-2">
                                            <div class="row my-3 pl-2">
                                                5. ECONOMÍA
                                            </div>
                                            <div class="row pl-3">
                                                <div class="col-12 form-group">
                                                    {{form.planes_sociales_guarda| as_crispy_field}}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-12 mt-2">
                                            <div class="row my-3 pl-2">
                                                6. TRABAJO
                                            </div>
                                            <div class="row pl-3">
                                                <div class="col-sm-4 form-group">
                                                    {{form.trabajo_actual_guarda| as_crispy_field}}
                                                </div>
                                                <div class="col-sm-4 form-group">
                                                    {{form.modo_contrat_guarda| as_crispy_field}}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a class="btn btn-secondary float-left mb-3 mt-5 " onclick="stepper.previous()">Volver</a>
                            <a class="btn btn-primary float-right mb-3 mt-5 " onclick="stepper.next()">Continuar</a>
                    </div>
                        <!--  Fin Guarda-->

                        <div id="cuidador-principal" class="content" role="tabpanel"
                            aria-labelledby="cuidador-principal-trigger">
                            <div class="col-12 mt-3">
                                <div class="card ">
                                    <div class="card-header">
                                        <div class="card-title font-weight-bold">
                                            Datos de la Madre o cuidador principal
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-sm-12 ">
                                                <div class="row my-3 pl-2">
                                                    1. DATOS PERSONALES
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-3 form-group">
                                                        <label>Madre o cuidador principal</label>
                                                        <select name="fk_legajo_1" class="form-control custom-select" id="id_fk_legajo_1">
                                                            <option value=""></option>
                                                            {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                            <option value="{{object.fk_legajo_1.id}}" selected>{{object.fk_legajo_1}}</option>
                                                            {% endif %}
                                                            {% for f in familia %}
                                                            <option value="{{f.fk_legajo_1.id}}">{{f.fk_legajo_1}}</option>
                                                            {% endfor %}
                                                            {% for f in familia_inversa %}
                                                            <option value="{{f.fk_legajo_2.id}}">{{f.fk_legajo_2}}</option>
                                                            {% endfor %}
                                                          </select>
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Vínculo</label>
                                                        <input type="text" class="form-control" id="vinculo1" name="vinculo1" 
                                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                        value="{{object.vinculo1}}"
                                                        {% endif %}
                                                        readonly>
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Tipo de documento</label>
                                                        <input type="text" class="form-control" id="tipo_doc"
                                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                        value="{{object.fk_legajo_1.tipo_doc}}"
                                                        {% endif %}
                                                        readonly>
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Numero documento</label>
                                                        <input type="text" class="form-control" id="documento" 
                                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                        value="{{object.fk_legajo_1.documento}}"
                                                        {% endif %}
                                                        readonly>
                                                    </div>

                                                </div>
                                            </div>
                                            <div class="col-sm-12">
                                                <div class="row my-3 pl-2">
                                                    2. FAMILIA
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-3 form-group">
                                                        <label>Cantidad de menores a cargo </label>
                                                        {{form.menores_a_cargo_1| as_crispy_field}}
                                                    </div>
                                                </div>

                                            </div>
                                            <div class="col-sm-12">
                                                <div class="row my-3 pl-2">
                                                    3. SALUD
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-3 form-group">
                                                        <label>¿Realiza controles ginecológicos?</label>
                                                        {{form.control_gine_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Cantidad total de hijos</label>
                                                        {{form.hijos_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Cantidad total de embarazos</label>
                                                        {{form.embarazos_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Cantidad de abortos espontáneos</label>
                                                        {{form.abortos_esp_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Cantidad de abortos provocados</label>
                                                        {{form.abortos_prov_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-12  form-group">
                                                        <div class="row my-3 font-weight-bold pl-2">¿Tiene
                                                            alguno
                                                            de estos
                                                            Antecedentes? <span
                                                                class="text-muted font-weight-normal pl-2 font-italic">(Marcar
                                                                todos los que correspondan)</span></div>
                                                        <div class="row pl-2">
                                                            <div class="col-sm-4">
                                                                <div class="form-group">
                                                                    {{form.emb_no_control_1| as_crispy_field}}
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4">
                                                                <div class="form-group">
                                                                    {{form.emb_adolescente_1| as_crispy_field}}
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4">
                                                                <div class="form-group">
                                                                    {{form.emb_riesgo_1| as_crispy_field}}
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4">
                                                                <div class="form-group">
                                                                    {{form.cesareas_multip_1| as_crispy_field}}
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4">
                                                                <div class="form-group">
                                                                    {{form.partos_multip_1| as_crispy_field}}
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4">
                                                                <div class="form-group">
                                                                    {{form.partos_premat_1| as_crispy_field}}
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4">
                                                                <div class="form-group">
                                                                    {{form.partos_menos18meses_1| as_crispy_field}}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-sm-3 form-group">
                                                        <label>¿Está embarazada actualmente?</label>
                                                        {{form.emb_actualmente_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>¿Tiene los controles?</label>
                                                        {{form.controles_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-6 form-group">
                                                        <label>Embarazo actual</label>
                                                        {{form.emb_actual_1| as_crispy_field}}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-12">
                                                <div class="row my-3 pl-2">
                                                    4. EDUCACIÓN
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-6 form-group">
                                                        <label>Máximo nivel alcanzado</label>
                                                        {{form.educ_maximo_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-6 form-group">
                                                        <label>Estado</label>
                                                        {{form.educ_estado_1| as_crispy_field}}
                                                    </div>
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.leer_1| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.escribir_1| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.retomar_estudios_1| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.aprender_oficio_1| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-12 mt-2">
                                                <div class="row my-3 pl-2">
                                                    5. ECONOMÍA
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-12 form-group">
                                                        <label>Planes sociales que recibe</label>
                                                        {{form.planes_sociales_1| as_crispy_field}}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-12 mt-2">
                                                <div class="row my-3 pl-2">
                                                    6. TRABAJO
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-4 form-group">
                                                        <label>¿Tiene trabajo actualmente?</label>
                                                        {{form.trabajo_actual_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-4 form-group">
                                                        <label>Ocupación</label>
                                                        {{form.ocupacion_1| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-4 form-group">
                                                        <label>Modo de contratación</label>
                                                        {{form.modo_contrat_1| as_crispy_field}}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <a class="btn btn-secondary float-left mb-3 mt-5 " onclick="stepper.previous()">Volver</a>
                                <a class="btn btn-primary float-right mb-3 mt-5 " onclick="stepper.next()">Continuar</a>
                        </div>

                        <div id="cuidador-secundario" class="content" role="tabpanel"
                            aria-labelledby="cuidador-secundario-trigger">
                            <div class="col-12 mt-3">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title font-weight-bold">
                                            Datos del padre o apoyo en la crianza
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-sm-12">
                                                <div class="row my-3 pl-2">
                                                    1. DATOS PERSONALES
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-3 form-group">
                                                        <label>Padre o apoyo en la crianza</label>
                                                        <select name="fk_legajo_2" class="form-control custom-select" id="id_fk_legajo_2">
                                                            <option value="" selected=""></option>
                                                            {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                            <option value="{{object.fk_legajo_2.id}}" selected>{{object.fk_legajo_2}}</option>
                                                            {% endif %}
                                                            {% for f in familia %}
                                                            <option value="{{f.fk_legajo_1.id}}">{{f.fk_legajo_1}}</option>
                                                            {% endfor %}
                                                            {% for f in familia_inversa %}
                                                            <option value="{{f.fk_legajo_2.id}}">{{f.fk_legajo_2}}</option>
                                                            {% endfor %}
                                                          </select>
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Vínculo</label>
                                                        <input type="text" class="form-control" id="vinculo2" name="vinculo2" 
                                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                        value="{{object.vinculo2}}"
                                                        {% endif %}readonly>
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Tipo de documento</label>
                                                        <input type="text" class="form-control" id="tipo_doc2" 
                                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                        value="{{object.fk_legajo_2.tipo_doc}}"
                                                        {% endif %}readonly>
                                                    </div>
                                                    <div class="col-sm-3 form-group">
                                                        <label>Numero documento</label>
                                                        <input type="text" class="form-control" id="documento2" 
                                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                                        value="{{object.fk_legajo_2.documento}}"
                                                        {% endif %}readonly>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-sm-12">
                                                <div class="row my-3 pl-2">
                                                    2. EDUCACIÓN
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-6 form-group">
                                                        <label>Máximo nivel alcanzado</label>
                                                        {{form.educ_maximo_2| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-6 form-group">
                                                        <label>Estado</label>
                                                        {{form.educ_estado_2| as_crispy_field}}
                                                    </div>
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.leer_2| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.escribir_2| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.retomar_estudios_2| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.aprender_oficio_2| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <div class="form-group">
                                                            {{form.programa_Pilares_2| as_crispy_field}}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-12 mt-2">
                                                <div class="row my-3 pl-2">
                                                    3. ECONOMÍA
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-12 form-group">
                                                        <label>Planes sociales que recibe</label>
                                                        {{form.planes_sociales_2| as_crispy_field}}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-12 mt-2">
                                                <div class="row my-3 pl-2">
                                                    4. TRABAJO
                                                </div>
                                                <div class="row pl-3">
                                                    <div class="col-sm-4 form-group">
                                                        <label>¿Tiene trabajo actualmente?</label>
                                                        {{form.trabajo_actual_2| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-4 form-group">
                                                        <label>Ocupación</label>
                                                        {{form.ocupacion_2| as_crispy_field}}
                                                    </div>
                                                    <div class="col-sm-4 form-group">
                                                        <label>Modo de contratación</label>
                                                        {{form.modo_contrat_2| as_crispy_field}}
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ./padre o apoyo a la crianza -->
                                        </div>

                                    </div>
                                </div>
                            </div>
                                <a class="btn btn-secondary float-left mb-3 mt-5 " onclick="stepper.previous()">Volver</a>
                                <a class="btn btn-primary float-right mb-3 mt-5 " onclick="stepper.next()">Continuar</a>
                        </div>

                        <div id="info-centro" class="content" role="tabpanel" aria-labelledby="info-centro-trigger">
                            <div class="form-row">
                                <div class="col-sm-3 form-group">
                                    <label for="id_centro_postula">Centro al que postula *</label>
                                    <select name="centro_postula" class="form-control custom-select {% if messages %}is-invalid{% endif %}" id="id_centro_postula" required>
                                        <option value="" selected=""></option>
                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                        <option value="{{object.centro_postula.id}}" selected>{{object.centro_postula}}</option>
                                        {% endif %}
                                        {% for c in centros %}
                                        <option value="{{c.id}}">{{c.nombre}}</option>
                                        {% endfor %}
                                      </select>
                                    {% comment %} <p id="error_1_id_centro_postula" class="invalid-feedback"><strong>Este campo es obligatorio.</strong></p> {% endcomment %}
                                </div>
                                <div class="col-sm-3 form-group">
                                    <label for="id_sala_postula">Sala que postula *</label>
                                    <select name="sala_postula" class="form-control custom-select {% if messages %}is-invalid{% endif %}" id="id_sala_postula" required>
                                        <option value="" selected=""></option>
                                        {%if request.resolver_match.url_name == "CDIF_preadmisiones_editar" %}
                                        <option value="{{object.sala_postula.id}}" selected>{{object.sala_postula}}</option>
                                        {% endif %}
                                        {% for c in cupos %}
                                        <option value="{{c.id}}" data-group="{{c.fk_vacante_id}}">{{c.nombre}}</option>
                                        {% endfor %}
                                      </select>
                                    {% comment %} <p id="error_1_id_centro_postula" class="invalid-feedback"><strong>Este campo es obligatorio.</strong></p> {% endcomment %}
                                </div>
                            </div>
                            <a class="btn btn-secondary float-left mb-3 mt-5 " onclick="stepper.previous()">Volver</a>
                            <button id="enviarFormulario" type="submit" class="btn btn-primary float-right mb-3 mt-5">Confirmar</button>
                        </div>


                        

                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock content %}


{% block customJS %}
<script>
    // BS-Stepper Init
    document.addEventListener('DOMContentLoaded', function () {
        window.stepper = new Stepper(document.querySelector('.bs-stepper'))
    });
    //Date picker
    $('#reservationdate').datetimepicker({
        format: 'L'
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
    // Asocia un evento change al SELECT
    $('#id_fk_legajo_1').change(function() {
        // Obtiene el valor seleccionado
        var seleccion = $(this).val();
        var tipo_doc = document.getElementById("tipo_doc");
        var documento = document.getElementById("documento");
        var vinculo = document.getElementById("vinculo1");

        // Lógica para determinar el contenido del div basado en la selección
        {% for f in familia %}
        if (seleccion === '{{f.fk_legajo_1.id}}') {
            tipo_doc.value = '{{f.fk_legajo_1.tipo_doc}}';
            documento.value = '{{f.fk_legajo_1.documento}}';
            vinculo.value = '{{f.vinculo_inverso}}';
        }
        {% endfor %}
        {% for f in familia_inversa %}
        if (seleccion === '{{f.fk_legajo_2.id}}') {
            tipo_doc.value = '{{f.fk_legajo_2.tipo_doc}}';
            documento.value = '{{f.fk_legajo_2.documento}}';
            vinculo.value = '{{f.vinculo}}';
        }
        {% endfor %}
    });

    // Asocia un evento change al SELECT
    $('#id_fk_legajo_2').change(function() {
        // Obtiene el valor seleccionado
        var seleccion = $(this).val();
        var tipo_doc = document.getElementById("tipo_doc2");
        var documento = document.getElementById("documento2");
        var vinculo = document.getElementById("vinculo2");

        // Lógica para determinar el contenido del div basado en la selección
        {% for f in familia %}
        if (seleccion === '{{f.fk_legajo_1.id}}') {
            tipo_doc.value = '{{f.fk_legajo_1.tipo_doc}}';
            documento.value = '{{f.fk_legajo_1.documento}}';
            vinculo.value = '{{f.vinculo_inverso}}';
        }
        {% endfor %}
        {% for f in familia_inversa %}
        if (seleccion === '{{f.fk_legajo_2.id}}') {
            tipo_doc.value = '{{f.fk_legajo_2.tipo_doc}}';
            documento.value = '{{f.fk_legajo_2.documento}}';
            vinculo.value = '{{f.vinculo}}';
        }
        {% endfor %}
    });

    // Asocia un evento change al SELECT
    $('#id_fk_legajo_3').change(function() {
        // Obtiene el valor seleccionado
        var seleccion = $(this).val();
        var tipo_doc = document.getElementById("tipo_doc3");
        var documento = document.getElementById("documento3");
        var vinculo = document.getElementById("vinculo3");

        // Lógica para determinar el contenido del div basado en la selección
        {% for f in familia %}
        if (seleccion === '{{f.fk_legajo_1.id}}') {
            tipo_doc.value = '{{f.fk_legajo_1.tipo_doc}}';
            documento.value = '{{f.fk_legajo_1.documento}}';
            vinculo.value = '{{f.vinculo_inverso}}';
        }
        {% endfor %}
        {% for f in familia_inversa %}
        if (seleccion === '{{f.fk_legajo_2.id}}') {
            tipo_doc.value = '{{f.fk_legajo_2.tipo_doc}}';
            documento.value = '{{f.fk_legajo_2.documento}}';
            vinculo.value = '{{f.vinculo}}';
        }
        {% endfor %}
    });

    // Asocia un evento change al SELECT
    $('#id_fk_legajo_4').change(function() {
        // Obtiene el valor seleccionado
        var seleccion = $(this).val();
        var tipo_doc = document.getElementById("tipo_doc4");
        var documento = document.getElementById("documento4");
        var vinculo = document.getElementById("vinculo4");

        // Lógica para determinar el contenido del div basado en la selección
        {% for f in familia %}
        if (seleccion === '{{f.fk_legajo_1.id}}') {
            tipo_doc.value = '{{f.fk_legajo_1.tipo_doc}}';
            documento.value = '{{f.fk_legajo_1.documento}}';
            vinculo.value = '{{f.vinculo_inverso}}';
        }
        {% endfor %}
        {% for f in familia_inversa %}
        if (seleccion === '{{f.fk_legajo_2.id}}') {
            tipo_doc.value = '{{f.fk_legajo_2.tipo_doc}}';
            documento.value = '{{f.fk_legajo_2.documento}}';
            vinculo.value = '{{f.vinculo}}';
        }
        {% endfor %}
    });

    // Asocia un evento change al SELECT
    $('#id_fk_legajo_5').change(function() {
        // Obtiene el valor seleccionado
        var seleccion = $(this).val();
        var tipo_doc = document.getElementById("tipo_doc5");
        var documento = document.getElementById("documento5");
        var vinculo = document.getElementById("vinculo5");

        // Lógica para determinar el contenido del div basado en la selección
        {% for f in familia %}
        if (seleccion === '{{f.fk_legajo_1.id}}') {
            tipo_doc.value = '{{f.fk_legajo_1.tipo_doc}}';
            documento.value = '{{f.fk_legajo_1.documento}}';
            vinculo.value = '{{f.vinculo_inverso}}';
        }
        {% endfor %}
        {% for f in familia_inversa %}
        if (seleccion === '{{f.fk_legajo_2.id}}') {
            tipo_doc.value = '{{f.fk_legajo_2.tipo_doc}}';
            documento.value = '{{f.fk_legajo_2.documento}}';
            vinculo.value = '{{f.vinculo}}';
        }
        {% endfor %}
    });




    $('#id_fk_legajo_GUARDA').change(function() {

        //var nivelG = document.getElementById("nivelG");
        // Obtiene el valor seleccionado
        var seleccion = $(this).val();
        // Lógica para determinar el contenido del div basado en la selección
        {% for f in familia %}
        console.log("{{f.fk_legajo_1.id}}")
        if (seleccion === '{{f.fk_legajo_1.id}}') {
            tipo_docGUARDA.value = '{{f.fk_legajo_1.tipo_doc}}';
            documentoGUARDA.value = '{{f.fk_legajo_1.documento}}';
            vinculoGUARDA.value = '{{f.vinculo}}';
            fecha_nacimientoGUARDA.value = '{{f.fk_legajo_1.fecha_nacimiento}}';
            estado_civilG.value = '{{f.fk_legajo_1.estado_civil}}';
            telefonoG.value = '{{f.fk_legajo_1.telefono}}';
            calleG.value = '{{f.fk_legajo_1.calle}}';
            alturaG.value = '{{f.fk_legajo_1.altura}}';
            pisoG.value = '{{f.fk_legajo_1.piso}}';
            circuitoG.value = '{{f.fk_legajo_1.circuito}}';
            barrioG.value = '{{f.fk_legajo_1.barrio}}';
            localidadG.value = '{{f.fk_legajo_1.localidad}}';
            nacionalidadG.value = '{{f.fk_legajo_1.nacionalidad}}';
        }
        {% endfor %}
        {% for f in familia_inversa %}
        console.log("{{f.fk_legajo_2.fecha_nacimiento}}")
        console.log("{{f.fk_legajo_2.estado_civil}}")
        console.log("{{f.fk_legajo_2.telefono}}")
        console.log("{{f.fk_legajo_2.calle}}")
        console.log("{{f.fk_legajo_2.altura}}")
        console.log("{{f.fk_legajo_2.piso}}")
        if (seleccion === '{{f.fk_legajo_2.id}}') {
            tipo_docGUARDA.value = '{{f.fk_legajo_2.tipo_doc}}';
            documentoGUARDA.value = '{{f.fk_legajo_2.documento}}';
            vinculoGUARDA.value = '{{f.vinculo}}';
            fecha_nacimientoGUARDA.value = '{{f.fk_legajo_2.fecha_nacimiento}}';
            estado_civilG.value = '{{f.fk_legajo_2.estado_civil}}';
            telefonoG.value = '{{f.fk_legajo_2.telefono}}';
            calleG.value = '{{f.fk_legajo_2.calle}}';
            alturaG.value = '{{f.fk_legajo_2.altura}}';
            pisoG.value = '{{f.fk_legajo_2.piso}}';
            circuitoG.value = '{{f.fk_legajo_2.circuito}}';
            barrioG.value = '{{f.fk_legajo_2.barrio}}';
            localidadG.value = '{{f.fk_legajo_2.localidad}}';
            nacionalidadG.value = '{{f.fk_legajo_2.nacionalidad}}';
        }
        {% endfor %}
        
        //  nivelG.value = '{{educacion.max_nivel}}';
        //  console.log( nivelG.value )

    });
});
</script>
{% comment %} SCRIPT DE GRUPO FAMILIAR {% endcomment %}
<script>
  // Disable form submissions if there are invalid fields
  (function () {
    'use strict';
    window.addEventListener('load', function () {
      // Get the forms we want to add validation styles to
      var forms = document.getElementsByClassName('needs-validation');
      var enviarFormulario = document.getElementById('enviarFormulario');
      // Loop over them and prevent submission
      var validation = Array.prototype.filter.call(forms, function (form) {
        enviarFormulario.addEventListener('submit', function (event) {
          var invalidFields = form.querySelectorAll(':invalid');
          if (invalidFields.length > 0) {
            // Si hay campos inválidos, detener la propagación del evento
            event.preventDefault();
            event.stopPropagation();

            // Iterar sobre los campos inválidos y agregar mensajes de obligatoriedad
            invalidFields.forEach(function (field) {
              if (field.hasAttribute('required')) {
                // Verificar si el mensaje de error ya existe
                if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
                  // Agregar un mensaje de obligatoriedad para los campos requeridos
                  var errorMessage = document.createElement('div');
                  errorMessage.className = 'invalid-feedback';
                  errorMessage.innerHTML = 'Este campo es obligatorio.';
                  field.parentNode.appendChild(errorMessage);
                }
              }
            });
          }
          form.classList.add('was-validated');
        }, false);
      });
    }, false);

    const url = window.location.href;
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const calle_field = document.getElementById('calle_field');
    const resultsBox = $('#results-box');
    const formNuevo = $('#nuevo_legajo_familiar');

    resultsBox.append('<td colspan="8" class="text-center text-muted h4">Realice una busqueda.</td>');
    const csrf = document.getElementsByName('csrfmiddlewaretoken')[0].value;

    const sendSearchData = (busqueda) => {
      $.ajax({
        type: 'POST',
        url: "{% url 'familiares_buscar' %}",
        data: {
          'csrfmiddlewaretoken': csrf,
          'busqueda': busqueda,
          'id': '{{ pk }}',
        },
        success: (res) => {
          const data = res.data
          if (Array.isArray(data)) {

            resultsBox.empty(); // Vaciar contenido anterior
            data.forEach(r => {
              resultsBox.append(`
                          <tr id="id_tr${r.pk}" >
                              <td>${r.apellido}</td>
                              <td>${r.nombre}</td>
                              <td>${r.documento}</td>
                              <td>{{nuevo_grupo_familiar_form.vinculo}}</td>
                              <td class="text-center">{{nuevo_grupo_familiar_form.estado_relacion }}</td>
                              <td class="text-center">{{nuevo_grupo_familiar_form.conviven}}</td>
                              <td class="text-center">{{nuevo_grupo_familiar_form.cuidador_principal}}</td>
                              <td class="text-center">{{nuevo_grupo_familiar_form.max_nivel}}</td>
                              <td>{{nuevo_grupo_familiar_form.estado_nivel}}</td>
                              <td class="text-right">
                                  <button class="btn btn-primary btn-sm" id="btn_1" onclick="submitForms('id_tr${r.pk}','${r.pk}');" type="button">Agregar</button>
                              </td>
                          </tr>
                      `);
            });
          } else {
            if (searchInput.value.length > 0) {
              resultsBox.empty(); // Vaciar contenido anterior
              formNuevo.removeClass('d-none')
            }
          }
        },
        error: (err) => {
          console.log("Error: ", err)
        }
      })
    }

    // Activa la búsqueda ajax cuando se ingresa texto
    searchInput.addEventListener('keyup', e => {
      $('#formulario-nuevo')[0].reset(); // Resetear el formulario
      formNuevo.addClass('d-none'); // Ocultar el formulario
      $('.is-invalid').removeClass('is-invalid'); // Quitar la clase 'is-invalid' de los campos inválidos
      $('.invalid-feedback').remove(); // Eliminar los mensajes de validación
      if (e.target.value.length > 1) {
        sendSearchData(e.target.value, "busqueda")
      } else {
        resultsBox.innerHTML = '<td colspan="8" class="text-center text-muted h4">Realice una búsqueda.</td>'
      }
    });

    $('#formulario-nuevo').submit(function (event) {
      event.preventDefault(); // Evitar el envío del formulario

      // Validar campos antes de enviar el formulario
      if (validarCampos()) {
        this.submit(); // Enviar el formulario si los campos son válidos
      }
    });




    // Verificar si hay errores en el formulario
    const form = $('#formulario-nuevo')
    let hasErrors = false;
    form.querySelectorAll('.is-invalid').forEach(function (field) {
      hasErrors = true;
      return false; // Salir del bucle si se encuentra un campo inválido
    });

    if (hasErrors) {
      document.getElementById('nuevo_legajo_familiar').classList.remove('d-none');
    } else {
      document.getElementById('nuevo_legajo_familiar').classList.add('d-none');
    }
  })();

  // Crea Django Ajax Call
  function submitForms(trId, pk) {

    var tr = document.getElementById(trId);
    var tdValues = tr.getElementsByTagName('td');
    var selectValues = tr.getElementsByTagName('select');
    var values = {};
    const addNombre = tdValues[0].innerHTML;
    const addApellido = tdValues[1].innerHTML;
    const addDocumento = tdValues[2].innerHTML;
    const addParentesco = selectValues[0].value;
    const addRelacion = selectValues[1].value;
    const addConviven = selectValues[2].value;
    const addCuidador = selectValues[3].value;
    const addNivelEducativo = selectValues[4].value;
    const addEstadoNivelEducativo = selectValues[5].value;

    // Validar que todos los campos select estén seleccionados
    var allFieldsSelected = true;
    Array.from(selectValues).forEach(function (select) {
      if (select.value === "") {
        allFieldsSelected = false;
        select.classList.add("is-invalid"); // Agregar clase 'is-invalid' para resaltar el campo inválido
      } else {
        select.classList.remove("is-invalid"); // Quitar clase 'is-invalid' si el campo es válido
      }
    });

    if (allFieldsSelected) {
      // Create Ajax Call
      $.ajax({
        url: '{% url "grupofamiliar_ajax_crear" %}',
        data: {
          'fk_legajo_1': '{{legajo.fk_legajo_id}}',
          'fk_legajo_2': pk,
          'vinculo': addParentesco,
          'estado_relacion': addRelacion,
          'conviven': addConviven,
          'cuidador_principal': addCuidador,
          'nivel_educativo': addNivelEducativo,
          'estado_nivel_educativo': addEstadoNivelEducativo,
        },
        dataType: 'json',
        success: function (data) {
          $("#tablaResultado").append(`
          <div id="familiar-${data.familiar.id} class="col-md-3">
              <ul class="users-list">
                  <li style="width:auto">
                      {% if data.familiar.foto is not None %}
                      <img src="{{MEDIA_URL}}${data.familiar.foto}" alt="User Image" width="60px">
                      {%else%}
                      <img src="{% static 'custom/img/default.png'  %}" alt="User Image" width="60px">
                      {%endif%}
                      <span class="users-list-name">${data.familiar.apellido}, ${data.familiar.nombre}</span>
                      <span class="users-list-date">${data.familiar.vinculo}</span>
                      <span class="users-list-date"><button
                          class="btn btn-danger btn-sm"
                          onclick='deleteFamiliar("${data.familiar.id}")'
                          type="submit">Eliminar</button></span>
                  </li>
              </ul>
          </div>
          `);
          $(searchInput).val(""); // Vaciar el campo de búsqueda
          resultsBox.empty(); // Vaciar contenido anterior   
          $('#sin-familiares').remove()
          toastr.options = { "positionClass": "toast-bottom-right", }
          toastr[data.data.tipo_mensaje](data.data.mensaje);
        }
      });
    location.reload();
    } else {
      // Mostrar un mensaje de error o realizar alguna acción en caso de campos incompletos
      console.log("Todos los campos deben estar completos");
    }
  }

  function deleteFamiliar(id) {
    $.ajax({
      url: '{% url "grupofamiliar_ajax_borrar" %}',
      data: {
        'id': id,
      },
      dataType: 'json',
      success: function (data) {
        $("#familiar-" + id).remove();
        $('#tablaResultado').load(window.location.href + ' #tablaResultado');
        $(searchInput).val(""); // Vaciar el campo de búsqueda
        resultsBox.empty(); // Vaciar contenido anterior
        resultsBox.append('<td colspan="8" class="text-center text-muted h4">Realice una busqueda.</td>')
        $('#formulario-nuevo')[0].reset();
        formNuevo.addClass('d-none')
        toastr.options = { "positionClass": "toast-bottom-right", }
        toastr[data.tipo_mensaje](data.mensaje);

      }
    });
  }

  function insertErrorMessage(element, message) {
    var small = document.createElement('small');
    small.classList.add('text-danger');
    small.textContent = message;

    var divWrapper = document.createElement('div');
    divWrapper.appendChild(small);

    var wrapper = document.createElement('div');
    wrapper.classList.add('error-wrapper');
    wrapper.appendChild(divWrapper);

    element.parentNode.insertBefore(wrapper, element.nextSibling);
  }

  function validarCampos() {
    let valido = true;

    // Validar cada campo individualmente
    $('#formulario-nuevo input, #formulario-nuevo select').each(function () {
      if ($(this).prop('required') && $(this).val() === '') {
        // Agregar clase de advertencia al campo vacío
        $(this).addClass('is-invalid');
        valido = false;
      } else {
        $(this).removeClass('is-invalid');
      }
    });

    return valido;
  }
</script>
{% endblock %}
